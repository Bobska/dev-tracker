{% extends 'base.html' %}

{% block title %}{{ task.title }} - Task Details{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center mb-2">
                <a href="{% url 'tracker:task_list' %}" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i> Back to Tasks
                </a>
                <h1 class="display-6 fw-bold mb-0">{{ task.title }}</h1>
                <span class="badge bg-{% if task.status == 'completed' %}success{% elif task.status == 'in-progress' %}warning{% else %}secondary{% endif %} ms-3">
                    {{ task.get_status_display }}
                </span>
                {% if task.is_overdue %}
                    <span class="badge bg-danger ms-2">Overdue</span>
                {% endif %}
            </div>
            <p class="lead text-muted">{{ task.description }}</p>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-light text-dark">{{ task.application.name }}</span>
                <span class="badge bg-{% if task.priority == 'high' %}danger{% elif task.priority == 'medium' %}warning{% else %}success{% endif %}">
                    {{ task.get_priority_display }} Priority
                </span>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{% url 'tracker:task_update' task.pk %}" class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i>Edit Task
                </a>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        Actions
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="markComplete()">
                            <i class="bi bi-check-circle me-1"></i>Mark Complete
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="markInProgress()">
                            <i class="bi bi-play-circle me-1"></i>Mark In Progress
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="confirmDelete()">
                            <i class="bi bi-trash me-1"></i>Delete Task
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-person display-4 text-primary"></i>
                    <h5 class="mt-2">{{ task.get_assignee_display }}</h5>
                    <p class="text-muted mb-0">Assignee</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-{% if task.priority == 'high' %}exclamation-triangle{% elif task.priority == 'medium' %}dash-circle{% else %}check-circle{% endif %} display-4 text-{% if task.priority == 'high' %}danger{% elif task.priority == 'medium' %}warning{% else %}success{% endif %}"></i>
                    <h5 class="mt-2">{{ task.get_priority_display }}</h5>
                    <p class="text-muted mb-0">Priority</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-{% if task.status == 'completed' %}check-circle{% elif task.status == 'in-progress' %}play-circle{% else %}pause-circle{% endif %} display-4 text-{% if task.status == 'completed' %}success{% elif task.status == 'in-progress' %}warning{% else %}secondary{% endif %}"></i>
                    <h5 class="mt-2">{{ task.get_status_display }}</h5>
                    <p class="text-muted mb-0">Status</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-calendar display-4 text-info"></i>
                    <h5 class="mt-2">
                        {% if task.due_date %}
                            {{ task.due_date|date:"M d" }}
                        {% else %}
                            No Date
                        {% endif %}
                    </h5>
                    <p class="text-muted mb-0">Due Date</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Details -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Task Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Application:</dt>
                        <dd class="col-sm-9">
                            <a href="{% url 'tracker:application_detail' task.application.pk %}">{{ task.application.name }}</a>
                        </dd>
                        
                        <dt class="col-sm-3">Project:</dt>
                        <dd class="col-sm-9">
                            <a href="{% url 'tracker:project_detail' task.application.project.pk %}">{{ task.application.project.name }}</a>
                        </dd>
                        
                        <dt class="col-sm-3">Assignee:</dt>
                        <dd class="col-sm-9">{{ task.get_assignee_display }}</dd>
                        
                        <dt class="col-sm-3">Priority:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-{% if task.priority == 'high' %}danger{% elif task.priority == 'medium' %}warning{% else %}success{% endif %}">
                                {{ task.get_priority_display }}
                            </span>
                        </dd>
                        
                        {% if task.estimated_hours %}
                        <dt class="col-sm-3">Estimated Hours:</dt>
                        <dd class="col-sm-9">{{ task.estimated_hours }} hours</dd>
                        {% endif %}
                        
                        {% if task.due_date %}
                        <dt class="col-sm-3">Due Date:</dt>
                        <dd class="col-sm-9">
                            {{ task.due_date|date:"F d, Y" }}
                            {% if task.is_overdue %}
                                <span class="badge bg-danger ms-2">Overdue</span>
                            {% endif %}
                        </dd>
                        {% endif %}
                        
                        <dt class="col-sm-3">Created:</dt>
                        <dd class="col-sm-9">{{ task.created_at|date:"F d, Y" }} at {{ task.created_at|time:"H:i" }}</dd>
                        
                        <dt class="col-sm-3">Last Updated:</dt>
                        <dd class="col-sm-9">{{ task.updated_at|date:"F d, Y" }} at {{ task.updated_at|time:"H:i" }}</dd>
                    </dl>

                    {% if task.description %}
                        <div class="mt-4">
                            <h6 class="text-muted">Full Description</h6>
                            <div class="border-start border-primary border-3 ps-3">
                                {{ task.description|linebreaks }}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Status & Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Current Status:</small>
                        <div class="mt-1">
                            <span class="badge bg-{% if task.status == 'completed' %}success{% elif task.status == 'in-progress' %}warning{% else %}secondary{% endif %} fs-6">
                                {{ task.get_status_display }}
                            </span>
                        </div>
                    </div>
                    
                    {% if task.due_date %}
                    <div class="mb-3">
                        <small class="text-muted">Time Remaining:</small>
                        <div class="mt-1">
                            {% if task.days_until_due > 0 %}
                                <span class="fw-semibold text-success">{{ task.days_until_due }} days left</span>
                            {% elif task.days_until_due == 0 %}
                                <span class="fw-semibold text-warning">Due today</span>
                            {% else %}
                                <span class="fw-semibold text-danger">{{ task.days_until_due|add:"0"|floatformat:"0" }} days overdue</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if task.estimated_hours %}
                    <div class="mb-3">
                        <small class="text-muted">Estimated Effort:</small>
                        <div class="mt-1">
                            <span class="fw-semibold">{{ task.estimated_hours }} hours</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Quick Status Change -->
                    <div class="mt-4">
                        <h6 class="text-muted mb-2">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            {% if task.status != 'completed' %}
                                <button type="button" class="btn btn-success btn-sm" onclick="markComplete()">
                                    <i class="bi bi-check-circle me-1"></i>Mark Complete
                                </button>
                            {% endif %}
                            {% if task.status != 'in-progress' %}
                                <button type="button" class="btn btn-warning btn-sm" onclick="markInProgress()">
                                    <i class="bi bi-play-circle me-1"></i>Mark In Progress
                                </button>
                            {% endif %}
                            {% if task.status != 'pending' %}
                                <button type="button" class="btn btn-secondary btn-sm" onclick="markPending()">
                                    <i class="bi bi-pause-circle me-1"></i>Mark Pending
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Related Tasks -->
            {% if related_tasks %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Related Tasks</h6>
                </div>
                <div class="card-body">
                    {% for related_task in related_tasks %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <a href="{% url 'tracker:task_detail' related_task.pk %}" class="text-decoration-none">
                                {{ related_task.title|truncatechars:30 }}
                            </a>
                            <span class="badge bg-{% if related_task.status == 'completed' %}success{% elif related_task.status == 'in-progress' %}warning{% else %}secondary{% endif %}">
                                {{ related_task.get_status_display }}
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Task History / Activity Log -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Activity Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6>Task Created</h6>
                                <p class="text-muted small mb-1">Task was created and assigned to {{ task.get_assignee_display }}</p>
                                <small class="text-muted">{{ task.created_at|date:"F d, Y" }} at {{ task.created_at|time:"H:i" }}</small>
                            </div>
                        </div>
                        
                        {% if task.updated_at != task.created_at %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6>Task Updated</h6>
                                <p class="text-muted small mb-1">Last modification to task details</p>
                                <small class="text-muted">{{ task.updated_at|date:"F d, Y" }} at {{ task.updated_at|time:"H:i" }}</small>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if task.status == 'completed' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6>Task Completed</h6>
                                <p class="text-muted small mb-1">Task marked as completed</p>
                                <small class="text-muted">{{ task.updated_at|date:"F d, Y" }} at {{ task.updated_at|time:"H:i" }}</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function markComplete() {
    if (confirm('Mark this task as completed?')) {
        // Add AJAX call to update status
        updateTaskStatus('completed');
    }
}

function markInProgress() {
    if (confirm('Mark this task as in progress?')) {
        updateTaskStatus('in-progress');
    }
}

function markPending() {
    if (confirm('Mark this task as pending?')) {
        updateTaskStatus('pending');
    }
}

function updateTaskStatus(status) {
    // Placeholder for AJAX status update
    console.log('Updating task status to:', status);
    // Reload page for now
    location.reload();
}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        // Add delete logic here
        window.location.href = "{% url 'tracker:task_list' %}";
    }
}
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 25px;
}

.timeline-marker {
    position: absolute;
    left: -8px;
    top: 5px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid #fff;
}

.timeline-content {
    margin-left: 20px;
}

.card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease-in-out;
}

.display-1 {
    opacity: 0.5;
}

.border-3 {
    border-width: 3px !important;
}
</style>
{% endblock %}
