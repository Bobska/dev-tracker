{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - FamilyHub Dev Tracker{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">Dashboard</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-speedometer2 me-2 text-primary"></i>
        Development Dashboard
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <select class="form-select form-select-sm" id="dateRangeFilter">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
                <option value="365">Last year</option>
            </select>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download me-1"></i>Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-pdf me-2"></i>PDF Report</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-excel me-2"></i>Excel Export</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary card-hover h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Projects
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalProjects">
                            {{ stats.total_projects|default:0 }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-collection fa-2x text-primary"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-success mr-2">
                        <i class="bi bi-arrow-up-circle"></i> {{ stats.project_completion_rate|floatformat:1 }}%
                    </span>
                    <span class="text-xs">Completion Rate</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success card-hover h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Applications
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalApplications">
                            {{ stats.total_applications|default:0 }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-grid-3x3-gap fa-2x text-success"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-success mr-2">
                        <i class="bi bi-arrow-up-circle"></i> {{ stats.app_completion_rate|floatformat:1 }}%
                    </span>
                    <span class="text-xs">In Production</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info card-hover h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Active Tasks
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeTasks">
                            {{ stats.total_tasks|default:0 }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-check2-square fa-2x text-info"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <div class="progress progress-custom">
                        <div class="progress-bar bg-info" style="width: {{ stats.task_completion_rate }}%"></div>
                    </div>
                    <span class="text-xs mt-1">{{ stats.task_completion_rate|floatformat:1 }}% Complete</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning card-hover h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Artifacts
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalArtifacts">
                            {{ stats.total_artifacts|default:0 }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-file-earmark-text fa-2x text-warning"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-muted text-xs">Documents & Files</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Recent Activity -->
<div class="row mb-4">
    <!-- Progress Charts -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Development Progress</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow">
                        <a class="dropdown-item" href="#" onclick="updateChart('monthly')">Monthly View</a>
                        <a class="dropdown-item" href="#" onclick="updateChart('weekly')">Weekly View</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" onclick="refreshChart()">Refresh Data</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="progressChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Status Distribution -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Project Status</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4 pb-2">
                    <canvas id="statusChart" width="200" height="200"></canvas>
                </div>
                <div class="mt-4 text-center small">
                    <span class="mr-2">
                        <i class="bi bi-circle-fill text-primary"></i> Active
                    </span>
                    <span class="mr-2">
                        <i class="bi bi-circle-fill text-success"></i> Completed
                    </span>
                    <span class="mr-2">
                        <i class="bi bi-circle-fill text-warning"></i> Planning
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity and Overdue Tasks -->
<div class="row">
    <!-- Recent Activity -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Recent Activity</h6>
                <a href="{% url 'tracker:artifact_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if recent_artifacts %}
                    <div class="timeline">
                        {% for artifact in recent_artifacts|slice:":5" %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-{% if artifact.status == 'complete' %}success{% elif artifact.status == 'in-progress' %}warning{% else %}secondary{% endif %}"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">
                                    <a href="{% url 'tracker:artifact_detail' artifact.pk %}">{{ artifact.name }}</a>
                                </h6>
                                <p class="text-muted small mb-1">{{ artifact.application.name }}</p>
                                <small class="text-muted">{{ artifact.updated_at|timesince }} ago</small>
                                <span class="badge bg-{{ artifact.status|cut:'-' }} ms-2">{{ artifact.get_status_display }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-clock-history display-4"></i>
                        <p class="mt-2">No recent activity</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Overdue Tasks & Pending Decisions -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-danger">Attention Required</h6>
            </div>
            <div class="card-body">
                <!-- Overdue Tasks -->
                {% if overdue_tasks %}
                    <h6 class="text-danger small mb-2">
                        <i class="bi bi-exclamation-triangle me-1"></i>Overdue Tasks ({{ overdue_tasks|length }})
                    </h6>
                    {% for task in overdue_tasks|slice:":3" %}
                    <div class="d-flex align-items-center mb-2">
                        <div class="flex-grow-1">
                            <a href="{% url 'tracker:task_detail' task.pk %}" class="text-decoration-none">
                                {{ task.title|truncatechars:40 }}
                            </a>
                            <br>
                            <small class="text-muted">{{ task.application.name }} â€¢ Due {{ task.due_date|timesince }} ago</small>
                        </div>
                        <span class="badge bg-danger">Overdue</span>
                    </div>
                    {% endfor %}
                    {% if overdue_tasks|length > 3 %}
                        <a href="{% url 'tracker:task_list' %}?overdue=true" class="btn btn-sm btn-outline-danger">
                            View All {{ overdue_tasks|length }} Overdue Tasks
                        </a>
                    {% endif %}
                {% endif %}

                <!-- Pending Decisions -->
                {% if pending_decisions %}
                    <h6 class="text-warning small mb-2 mt-3">
                        <i class="bi bi-lightbulb me-1"></i>Pending Decisions ({{ pending_decisions|length }})
                    </h6>
                    {% for decision in pending_decisions|slice:":3" %}
                    <div class="d-flex align-items-center mb-2">
                        <div class="flex-grow-1">
                            <a href="{% url 'tracker:decision_detail' decision.pk %}" class="text-decoration-none">
                                {{ decision.title|truncatechars:40 }}
                            </a>
                            <br>
                            <small class="text-muted">{{ decision.project.name }} â€¢ {{ decision.created_at|timesince }} ago</small>
                        </div>
                        <span class="badge bg-warning">Pending</span>
                    </div>
                    {% endfor %}
                {% endif %}

                {% if not overdue_tasks and not pending_decisions %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-check-circle display-4 text-success"></i>
                        <p class="mt-2">All caught up! ðŸŽ‰</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2 col-6 mb-3">
                        <a href="{% url 'tracker:project_create' %}" class="btn btn-outline-primary btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="bi bi-plus-circle display-6"></i>
                            <small>New Project</small>
                        </a>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <a href="{% url 'tracker:application_create' %}" class="btn btn-outline-success btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="bi bi-grid-3x3-gap display-6"></i>
                            <small>New App</small>
                        </a>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <a href="{% url 'tracker:task_create' %}" class="btn btn-outline-info btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="bi bi-check2-square display-6"></i>
                            <small>New Task</small>
                        </a>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <a href="{% url 'tracker:artifact_create' %}" class="btn btn-outline-warning btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="bi bi-file-earmark-text display-6"></i>
                            <small>New Artifact</small>
                        </a>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <a href="{% url 'tracker:decision_create' %}" class="btn btn-outline-secondary btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="bi bi-lightbulb display-6"></i>
                            <small>New Decision</small>
                        </a>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <a href="{% url 'tracker:integration_create' %}" class="btn btn-outline-dark btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="bi bi-diagram-3 display-6"></i>
                            <small>New Integration</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df!important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a!important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc!important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e!important;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -8px;
    top: 5px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid #fff;
}

.timeline-content {
    margin-left: 20px;
}
</style>

                        <small class="text-muted">{{ total_tasks }} total tasks</small>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card dashboard-stat-card h-100">
                <div class="card-body text-center">
                    <div class="dashboard-stat-number text-success">{{ completed_tasks }}</div>
                    <h6 class="card-title text-muted">Completed</h6>
                    <p class="card-text">
                        <small class="text-success">Tasks finished</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning-charge me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <a href="{% url 'tracker:project_create' %}" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-plus-circle me-2"></i>
                                New Project
                            </a>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <a href="{% url 'tracker:application_create' %}" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-app-indicator me-2"></i>
                                New App
                            </a>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <a href="{% url 'tracker:task_create' %}" class="btn btn-info btn-lg w-100">
                                <i class="bi bi-check2-square me-2"></i>
                                New Task
                            </a>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <a href="{% url 'tracker:artifact_create' %}" class="btn btn-warning btn-lg w-100">
                                <i class="bi bi-file-earmark-plus me-2"></i>
                                New Artifact
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_activities %}
                    <div class="timeline">
                        {% for activity in recent_activities %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-{{ activity.color }}"></div>
                            <div class="timeline-content">
                                <h6 class="timeline-title">{{ activity.title }}</h6>
                                <p class="timeline-text text-muted">{{ activity.description }}</p>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    {{ activity.timestamp|timesince }} ago
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-4">
                        <i class="bi bi-inbox display-4 d-block mb-3"></i>
                        No recent activity to display
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Overdue Tasks
                    </h5>
                </div>
                <div class="card-body">
                    {% if overdue_tasks %}
                    {% for task in overdue_tasks %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                        <div>
                            <h6 class="mb-1">{{ task.title }}</h6>
                            <small class="text-muted">{{ task.application.name }}</small>
                        </div>
                        <span class="badge bg-danger">
                            {{ task.due_date|timesince }} overdue
                        </span>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted text-center py-3">
                        <i class="bi bi-check-circle display-6 d-block mb-2 text-success"></i>
                        No overdue tasks!
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        Project Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="progressChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart me-2"></i>
                        Task Status Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="statusChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if applications.exists %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-app me-2"></i>
                        Application Status Overview
                    </h5>
                    <a href="{% url 'tracker:application_list' %}" class="btn btn-sm btn-outline-primary">
                        View All <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for app in applications %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card border-left-{{ app.get_status_color }} h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">{{ app.name }}</h6>
                                        <span class="badge bg-{{ app.get_status_color }}">{{ app.get_status_display }}</span>
                                    </div>
                                    <p class="card-text text-muted small">{{ app.description|truncatechars:80 }}</p>
                                    <div class="mt-3">
                                        <div class="progress mb-2" style="height: 6px;">
                                            <div class="progress-bar bg-{{ app.get_status_color }}" 
                                                 style="width: {{ app.completion_percentage }}%"></div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">{{ app.completion_percentage }}% complete</small>
                                            <div>
                                                <span class="badge bg-light text-dark">{{ app.task_set.count }} tasks</span>
                                                <span class="badge bg-light text-dark">{{ app.artifact_set.count }} artifacts</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize Charts
document.addEventListener('DOMContentLoaded', function() {
    initProgressChart();
    initStatusChart();
});

function initProgressChart() {
    const ctx = document.getElementById('progressChart').getContext('2d');
    const chartData = {{ chart_data|safe }};
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels || [],
            datasets: [{
                label: 'Completed Tasks',
                data: chartData.completed || [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Total Tasks',
                data: chartData.total || [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initStatusChart() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    const statusData = {{ status_distribution|safe }};
    
    const labels = statusData.map(item => item.status.charAt(0).toUpperCase() + item.status.slice(1));
    const data = statusData.map(item => item.count);
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#4e73df',
                    '#1cc88a',
                    '#36b9cc',
                    '#f6c23e',
                    '#e74a3b'
                ],
                hoverBackgroundColor: [
                    '#2e59d9',
                    '#17a673',
                    '#2c9faf',
                    '#dda20a',
                    '#be2617'
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            cutout: '70%'
        }
    });
}

function updateChart(period) {
    // Implement chart update based on period
    console.log('Updating chart for period:', period);
    // This would make an AJAX call to get new data
}

function refreshChart() {
    console.log('Refreshing chart data...');
    // This would reload the chart with fresh data
    location.reload();
}

// Auto-refresh dashboard every 5 minutes
setInterval(function() {
    loadFooterStats();
}, 300000);
</script>
{% endblock %}
